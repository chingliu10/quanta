<style>
    .status-badge {
        font-size: 0.875rem;
        font-weight: 500;
        padding: 0.5rem 1rem;
        border-radius: 50px;
        display: inline-block;
    }

    .status-pending {
        background-color: #fff3cd;
        color: #856404;
        border: 1px solid #ffeaa7;
    }

    .status-disbursed {
        background-color: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
    }

    .status-closed {
        background-color: #e2e3e5;
        color: #383d41;
        border: 1px solid #d6d8db;
    }

    .info-card {
        transition: transform 0.2s ease-in-out;
    }

    .info-card:hover {
        transform: translateY(-2px);
    }

    .pending-alert {
        background: linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%);
        border: none;
        border-left: 4px solid #ffc107;
    }

    .detail-row {
        border-bottom: 1px solid #f8f9fa;
        padding: 0.75rem 0;
    }

    .detail-row:last-child {
        border-bottom: none;
    }

    .loan-amount {
        font-size: 1.5rem;
        font-weight: 700;
        color: #198754;
    }

    .section-header {
        color: #495057;
        font-weight: 600;
        margin-bottom: 1rem;
        padding-bottom: 0.5rem;
        border-bottom: 2px solid #e9ecef;
    }
</style>

<div class="app-content-header">
    <div class="container-fluid">
        <div class="row">
            <div class="col-sm-6">
                <h5 class="mb-0">Loan Details</h5>
            </div>
            <div class="col-sm-6">
                <ol class="breadcrumb float-sm-end">
                    <li class="breadcrumb-item"><a href="/loans">Loans</a></li>
                    <li class="breadcrumb-item active">Loan Details</li>
                </ol>
            </div>
        </div>
    </div>
</div>

<div class="app-content">
    <div class="container-fluid">

        <!-- Header Card -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card shadow-sm">
                    <div class="card-body">
                        <div class="row align-items-center">
                            <div class="col-md-8">
                                <h6 class="mb-1">
                                    <i class="bi bi-file-text me-2"></i>
                                    Loan #{{data.loan.loan_id}}
                                </h6>
                                <p class="text-muted mb-0">
                                    <i class="bi bi-person me-1"></i>
                                    {{data.loan.first_name}} {{data.loan.last_name}}
                                </p>
                            </div>
                            <div class="col-md-4 text-md-end">
                                <span class="status-badge status-{{data.loan.status}}">
                                    {{#if (eq data.loan.status "pending")}}
                                        <i class="bi bi-clock me-1"></i> Pending
                                    {{else if (eq data.loan.status "disbursed")}}
                                        <i class="bi bi-check-circle me-1"></i> Disbursed
                                    {{else if (eq data.loan.status "closed")}}
                                        <i class="bi bi-lock me-1"></i> Closed
                                    {{else}}
                                        {{data.loan.status}}
                                    {{/if}}
                                </span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Loan Information Panels -->
        <div class="row">
            <!-- Borrower Info -->
            <div class="col-lg-6 mb-4">
                <div class="card h-100 info-card shadow-sm">
                    <div class="card-body">
                        <h6 class="section-header"><i class="bi bi-person-circle me-2"></i>Borrower Information</h6>

                        <div class="detail-row">
                            <div class="row">
                                <div class="col-4"><span class="text-muted">Full Name:</span></div>
                                <div class="col-8"><strong>{{data.loan.first_name}} {{data.loan.last_name}}</strong></div>
                            </div>
                        </div>

                        <div class="detail-row">
                            <div class="row">
                                <div class="col-4"><span class="text-muted">Borrower ID:</span></div>
                                <div class="col-8"><code>#{{data.loan.borrower_id}}</code></div>
                            </div>
                        </div>

                        <div class="detail-row">
                            <div class="row">
                                <div class="col-4"><span class="text-muted">Applied On:</span></div>
                                <div class="col-8"><span id="application-date">{{formatDate data.loan.created_at}}</span></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Loan Info -->
            <div class="col-lg-6 mb-4">
                <div class="card h-100 info-card shadow-sm">
                    <div class="card-body">
                        <h6 class="section-header"><i class="bi bi-cash-stack me-2"></i>Loan Application Details</h6>

                        <div class="text-center mb-3">
                            <div class="loan-amount" id="loan-amount">{{formatCurrency data.loan.principal}}</div>
                            <small class="text-muted">Requested Amount</small>
                        </div>

                        <div class="detail-row">
                            <div class="row">
                                <div class="col-5"><span class="text-muted">Interest Rate:</span></div>
                                <div class="col-7"><strong>{{data.loan.interest_rate}}% {{data.loan.interest_period}}</strong></div>
                            </div>
                        </div>

                        <div class="detail-row">
                            <div class="row">
                                <div class="col-5"><span class="text-muted">Loan Term:</span></div>
                                <div class="col-7"><strong id="duration">{{data.loan.loan_duration}} </strong> <strong id="durationType">{{data.loan.loan_duration_type}}</strong></div>
                            </div>
                        </div>

                        <div class="detail-row">
                            <div class="row">
                                <div class="col-5"><span class="text-muted">Repayment Cycle:</span></div>
                                <div class="col-7 text-capitalize"><strong>{{data.loan.repayment_cycle}}</strong></div>
                            </div>
                        </div>

                        {{#if data.loan.product_name}}
                        <div class="detail-row">
                            <div class="row">
                                <div class="col-5"><span class="text-muted">Product:</span></div>
                                <div class="col-7"><strong>{{data.loan.product_name}}</strong></div>
                            </div>
                        </div>
                        {{/if}}

                        <div class="detail-row">
                            <div class="row">
                                <div class="col-5"><span class="text-muted">Interest Method:</span></div>
                                <div class="col-7 text-capitalize"><strong id="interest_method">{{data.loan.interest_method}}</strong></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Payment Schedule -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card shadow-sm">
                    <div class="card-body">
                        <h6 class="section-header mb-3"><i class="bi bi-calendar-week me-2"></i>Projected Payment Schedule</h6>

                        <div id="scheduleContainer" class="d-none"></div>

                        <div id="scheduleTable">
                            <div class="table-responsive">
                                <table class="table table-striped table-hover">
                                    <thead class="table-info">
                                        <tr>
                                            <th>Payment #</th>
                                            <th>Due Date</th>
                                            <th>Principal</th>
                                            <th>Interest</th>
                                            <th>Fees</th>
                                            <th>Total Due</th>
                                            <th>Balance</th>
                                        </tr>
                                    </thead>
                                    <tbody id="scheduleTableBody"></tbody>
                                </table>
                            </div>

                            <div class="row mt-3">
                                <div class="col-md-3">
                                    <div class="card bg-primary text-white text-center">
                                        <div class="card-body">
                                            <small>Total Principal</small>
                                            <div id="totalPrincipal">0</div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="card bg-warning text-white text-center">
                                        <div class="card-body">
                                            <small>Total Interest</small>
                                            <div id="totalInterest">0</div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="card bg-info text-white text-center">
                                        <div class="card-body">
                                            <small>Total Fees</small>
                                            <div id="totalFees">0</div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="card bg-success text-white text-center">
                                        <div class="card-body">
                                            <small>Total Amount</small>
                                            <div id="totalAmount">0</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div> <!-- End schedule table -->
                    </div>
                </div>
            </div>
        </div>

    </div>
</div>

<script type="module">
    import { LoanScheduleCalculator } from '/js/loan.js';
    const loanRawData = {{{json data.loan}}};

    function renderSchedule(loanRawData) {
        const loanData = {
            principalAmount: loanRawData.principal,
            releaseDate: new Date(loanRawData.release_date).toISOString().split('T')[0],
            interestMethod: loanRawData.interest_method,
            interestRate: parseFloat(loanRawData.interest_rate),
            interestPeriod: loanRawData.interest_period.toLowerCase(),
            duration: loanRawData.loan_duration,
            durationType: loanRawData.loan_duration_type,
            repaymentCycle: loanRawData.repayment_cycle.toLowerCase()
        };

        const calculator = new LoanScheduleCalculator(loanData);
        const schedule = calculator.generateSchedule();

        const tbody = document.getElementById("scheduleTableBody");
        tbody.innerHTML = "";

        let totalPrincipal = 0;
        let totalInterest = 0;
        let totalFees = 0;
        let totalAmount = 0;

        schedule.forEach(row => {
            const tr = document.createElement('tr');
            Object.values(row).forEach((val, idx) => {
                const td = document.createElement('td');
                td.textContent = val;
                tr.appendChild(td);

                if (idx === 2) totalPrincipal += parseFloat(val);
                if (idx === 3) totalInterest += parseFloat(val);
                if (idx === 4) totalFees += parseFloat(val);
                if (idx === 5) totalAmount += parseFloat(val);
            });
            tbody.appendChild(tr);
        });

        document.getElementById("totalPrincipal").textContent = totalPrincipal.toFixed(2);
        document.getElementById("totalInterest").textContent = totalInterest.toFixed(2);
        document.getElementById("totalFees").textContent = totalFees.toFixed(2);
        document.getElementById("totalAmount").textContent = totalAmount.toFixed(2);
    }

    // Auto-generate the schedule on page load
    renderSchedule(loanRawData);
</script>
